<html>
  <head>
    <title>HTMLBars example</title>
    <style type="text/css">
      #inputs {
        overflow: hidden;
      }

      #inputs label {
        float: left;
      }

      #inputs textarea {
        display: block;
        width: 300px;
        height: 150px;
        margin: 5px 10px 5px 0px;
        font-family: monospace;
      }
    </style>
  </head>
  <body>
    <div id="inputs">
      <label>
        Data
        <textarea id="data">{"name": "Bob"}</textarea>
      </label>

      <label>
        Template
        <textarea id="template">Howdy {{name}}</textarea>
      </label>

      <label>
        Options
        <textarea id="options">{ "disableComponentGeneration": false }</textarea>
      </label>
    </div>

    <div id="actions">
      <button id="compile-template">Compile</button>
      <button id="run-template">Compile and Render</button>
    </div>

    <hr>

    <div id="output"></div>

    <script src="../assets/loader.js"></script>
    <script>loader.noConflict({ define: 'enifed' });</script>
    <script src="../amd/dom-helper.amd.js"></script>
    <script src="../amd/htmlbars-compiler.amd.js"></script>
    <script src="../amd/htmlbars-runtime.amd.js"></script>
    <script>
      var compileBtn = document.getElementById('compile-template'),
          runBtn     = document.getElementById('run-template'),
          dataarea   = document.getElementById('data'),
          textarea   = document.getElementById('template'),
          output     = document.getElementById('output'),
          skipRender = document.getElementById('skip-render'),
          options    = document.getElementById('options');

      var compiler    = requireModule('htmlbars-compiler'),
          DOMHelper   = requireModule('dom-helper').default,
          hooks       = requireModule('htmlbars-runtime').hooks,
          render      = requireModule('htmlbars-runtime').render,
          Template    = requireModule('htmlbars-runtime').Template;

      var templateSource = localStorage.getItem('templateSource');
      var data = localStorage.getItem('templateData');

      if (templateSource) {
        textarea.value = templateSource;
      }

      if (data) {
        dataarea.value = data;
      }

      compileBtn.addEventListener('click', function() { compile(false); });
      runBtn.addEventListener('click', function() { compile(true); });

      function compile(shouldRender) {
        var source = textarea.value,
            data = dataarea.value,
            compileOptions;

        localStorage.setItem('templateSource', source);
        localStorage.setItem('templateData', data);

        try {
          data = JSON.parse(data);
        } catch(e) {
          data = {};
        }

        try {
          compileOptions = JSON.parse(options.value);
        } catch(e) {
          compileOptions = {};
        }

        var templateSpec = compiler.compileSpec(source, compileOptions);
        var templates = Template.fromSpec(JSON.parse(templateSpec)).prettyPrint();

        output.innerHTML = '';

        templates.forEach(function(template, index) {
          var h3 = document.createElement('h3');
          h3.innerHTML = 'Template ' + index;
          output.appendChild(h3);

          if (template.length === 0) {
            var pre = document.createElement('pre');
            pre.innerText = 'Empty Template';
            output.appendChild(pre);
            return;
          }

          var ol = document.createElement('ol');
          ol.setAttribute('start', '0');
          output.appendChild(ol);

          template.forEach(function(t) {
            var li = document.createElement('li');
            ol.appendChild(li);
            var pre = document.createElement('pre');
            li.appendChild(pre);
            pre.innerText = t;
          });
        });

        if (shouldRender) {
          var template = compiler.template(templateSpec);

          var env = { dom: new DOMHelper(), hooks: hooks, helpers: {} };

          var scope = hooks.createFreshScope();

          hooks.bindSelf(env, scope, data);

          var dom = render(template, env, scope, { contextualElement: output }).fragment;

          output.innerHTML += '<hr><pre><code>' + JSON.stringify(data) + '</code></pre><hr>';
          output.appendChild(dom);
        }
      }

      window.onerror = function(msg, file, line, column, e) {
        if (e && e.stack) {
          output.innerHTML = '<pre><code>' + e.stack + '</code></pre>';
        } else {
          output.innerHTML = '<pre><code>' + msg + '</code></pre>';
        }
      }
    </script>
  </body>
</html>
